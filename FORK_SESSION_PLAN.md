# Forked Session Plan

Date: 2026-01-10

## Goals
- Add a fork command that creates a new workspace/worktree off the current workspace branch.
- Inject the full transcript (including tool output) into a new session at fork time.
- Persist only minimal fork metadata; rely on real agent session files for restore.
- Suppress the first assistant reply generated by the seed prompt **only during the initial fork** (not on restore).

## Constraints & Decisions
- Works for both agents (Claude/Codex), but forks are agent-specific.
- True branching via new session IDs (never reuse the parent session).
- Full transcript injected (no summarization).
- Forking is blocked while the agent is streaming/processing.
- Dirty workspace: warn and require confirmation/suggest commit.
- Keybinding: **Alt+Shift+F**.

## Implementation Steps

### 1) Action + Keybinding + Command Palette
- Add `Action::ForkSession` in `src/ui/action.rs`.
- Add to `show_in_palette()` and `palette_description()`.
- Add default keybinding `M-S-f` in `src/config/default_keys.rs` (Alt+Shift+F).

### 2) Fork Confirmation Dialog
- Reuse `ConfirmationDialogState` with a new `ConfirmationContext::ForkSession`.
- Dialog content should include:
  - Agent type/model
  - Current session id
  - Token estimate vs context window
  - Warnings: dirty worktree, near/over context limit
- Block if `is_processing` is true (show error dialog).

### 3) Fork Metadata Persistence
- Add `fork_seeds` table with:
  - `id`, `agent_type`, `parent_session_id`, `parent_workspace_id`, `created_at`
  - `seed_prompt_hash`, `seed_prompt_path` (optional), `token_estimate`, `context_window`
  - `seed_ack_filtered` (bool)
- Add `fork_seed_id` to `SessionTab`.
- Store only minimal fork metadata; **do not** snapshot or persist the raw transcript/seed prompt in SQLite.

### 4) Transcript Capture + Seed Prompt Builder
- Serialize `ChatView.messages()` into a stable transcript format with:
  - Role (user/assistant/tool/system/error/summary)
  - For tools: name, args, output, exit code
- Build seed prompt:
  - Header marker: `[CONDUIT_FORK_SEED]`
  - Instruction: context-only, do not execute, respond with `Ready.`
  - Append transcript in a role-tagged format
- Estimate tokens from the seed prompt length; store estimate + context window.

### 5) Fork Execution
- Create a new worktree/workspace **from the current workspace branch**.
- Create a new tab bound to that workspace.
- Attach `fork_seed_id` to the tab.
- Auto-submit the seed prompt immediately (to create real CLI session files).
- Add a system message: “Fork created; context injected; waiting for your next prompt.”

### 6) Suppress the Seed Ack (Initial Fork Only)
- Track a per-tab flag (e.g., `pending_fork_ack_filter`).
- When the first assistant message arrives after seed injection, drop it once.
- Do **not** suppress any messages on restore (transparency).

### 7) Restore Behavior
- Keep current restore logic (load from agent JSONL).
- If forked, show the seed and all agent responses as they appear in the real session file.

### 8) Tests + Validation
- Unit tests for:
  - Transcript serialization
  - Seed prompt builder
  - Ack suppression behavior
- Run `cargo check --all`.

## Open Points to Decide During Implementation
- Exact formatting of the transcript blocks in the seed prompt.
- Thresholds for warning levels (e.g., >80% context usage).
